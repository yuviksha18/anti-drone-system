#include <TinyGPS++.h>

// --- Motor Pins (Arduino Mega) ---
const int ENA = 2;  const int IN1 = 22; const int IN2 = 23; // Left Side
const int ENB = 3;  const int IN3 = 24; const int IN4 = 25; // Right Side

// --- GPS Object & Serial ---
TinyGPSPlus gps;
// Using Serial2 (Pins 17 & 16) for GPS

void setup() {
  // Debugging Serial (USB)
  Serial.begin(9600);
  
  // GPS Serial (M8N usually 9600, try 38400 if no data)
  Serial2.begin(9600); 

  // Motor Setup
  pinMode(ENA, OUTPUT); pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(ENB, OUTPUT); pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);

  Serial.println("--- RC GPS CAR INITIALIZED ---");
  Serial.println("Waiting for GPS data...");
}

void loop() {
  // 1. Read GPS Data
  while (Serial2.available() > 0) {
    if (gps.encode(Serial2.read())) {
      displayGPSInfo();
    }
  }

  // 2. Error Check: If no data is hitting the chip
  if (millis() > 5000 && gps.charsProcessed() < 10) {
    Serial.println("ERROR: No GPS wires detected. Check Green/Yellow connections.");
    delay(2000);
  }
}

void displayGPSInfo() {
  if (gps.location.isValid()) {
    Serial.print("LAT: "); Serial.print(gps.location.lat(), 6);
    Serial.print(" | LNG: "); Serial.print(gps.location.lng(), 6);
    Serial.print(" | SPEED: "); Serial.print(gps.speed.kmph());
    Serial.println(" km/h");
  } else {
    // If we have data but no "Lock" yet
    Serial.print("Satellites in view: ");
    Serial.println(gps.satellites.value());
  }
}

// --- Movement Functions (Ready for later use) ---
void moveForward() {
  analogWrite(ENA, 255); digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  analogWrite(ENB, 255); digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}